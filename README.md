# Laravel TypeScript Models

Automatically generate TypeScript interfaces from your Laravel Eloquent models via an API endpoint.

## Features

- Generate TypeScript interfaces from Eloquent models
- Automatic array type generation (`export type Users = User[];`)
- Smart relationship detection with correct types (`perfil: Perfil`, `posts: Post[]`)
- Multiple detection strategies (return type, PHPDoc, method body analysis)
- Security features: token authentication, IP whitelist, disabled by default
- Configurable: fillable, database schema, or both

## Installation

```bash
composer require campelo/laravel-typescript-models
```

The package will automatically register its service provider.

## Configuration

Publish the configuration file:

```bash
php artisan vendor:publish --tag=typescript-models-config
```

This will create a `config/typescript-models.php` file in your application.

### Environment Variables

Add these to your `.env` file:

```env
# Enable the endpoint (disable in production!)
TYPESCRIPT_MODELS_ENABLED=true

# Secret token for authentication
TYPESCRIPT_MODELS_TOKEN=your-secret-token-here

# Optional: Custom route path
TYPESCRIPT_MODELS_ROUTE=/api/typescript-models

# Optional: Allowed IPs (comma-separated)
TYPESCRIPT_MODELS_ALLOWED_IPS=127.0.0.1,::1

# Optional: Disable token requirement (not recommended)
TYPESCRIPT_MODELS_REQUIRE_TOKEN=true

# Optional: Properties mode (fillable, database, or both)
TYPESCRIPT_MODELS_PROPERTIES_MODE=fillable

# Optional: Include accessors and relations
TYPESCRIPT_MODELS_INCLUDE_ACCESSORS=false
TYPESCRIPT_MODELS_INCLUDE_RELATIONS=true
```

## Usage

### Fetching TypeScript Interfaces

Make a GET request to the configured endpoint:

```bash
# Using token in header
curl -H "X-TypeScript-Token: your-secret-token" http://localhost/api/typescript-models

# Using Bearer token
curl -H "Authorization: Bearer your-secret-token" http://localhost/api/typescript-models

# Using query parameter
curl "http://localhost/api/typescript-models?token=your-secret-token"
```

### Example Output

```typescript
// =============================================================================
// Auto-generated TypeScript interfaces from Laravel Models
// Generated at: 2024-01-15T10:30:00+00:00
// Do not edit this file manually - it will be overwritten
// =============================================================================

export interface Perfil {
  id: number;
  bio?: string;
  user_id?: number;
  created_at?: Date;
  updated_at?: Date;
}

export interface Post {
  id: number;
  content?: string;
  title?: string;
  user_id?: number;
  created_at?: Date;
  updated_at?: Date;
  user?: User;
}

export interface User {
  id: number;
  birth_date?: Date;
  email?: string;
  name?: string;
  created_at?: Date;
  updated_at?: Date;
  perfil?: Perfil;
  posts?: Post[];
}

// Array Types
export type Perfis = Perfil[];
export type Posts = Post[];
export type Users = User[];
```

### Integrating with Your Frontend

You can create a script to automatically fetch and save the types:

```json
// package.json
{
  "scripts": {
    "types:generate": "curl -H 'X-TypeScript-Token: your-token' http://localhost/api/typescript-models > src/types/models.d.ts"
  }
}
```

Then run:

```bash
npm run types:generate
```

## Relationship Detection

The package uses **3 strategies** to detect relationships (in order of priority):

### 1. Return Type (Recommended)

```php
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Database\Eloquent\Relations\HasMany;

public function perfil(): HasOne
{
    return $this->hasOne(Perfil::class);
}

public function posts(): HasMany
{
    return $this->hasMany(Post::class);
}
```

### 2. PHPDoc Annotation

```php
/**
 * @return \Illuminate\Database\Eloquent\Relations\HasOne
 */
public function perfil()
{
    return $this->hasOne(Perfil::class);
}

/**
 * @return HasMany
 */
public function posts()
{
    return $this->hasMany(Post::class);
}
```

### 3. Method Body Analysis

If no return type or PHPDoc is found, the package analyzes the method body looking for relation calls like `$this->hasMany(`, `$this->belongsTo(`, etc.

```php
// Will be detected automatically!
public function posts()
{
    return $this->hasMany(Post::class);
}
```

### Supported Relationships

| Relationship | TypeScript Type |
|--------------|-----------------|
| `HasOne` | `RelatedModel` |
| `BelongsTo` | `RelatedModel` |
| `MorphOne` | `RelatedModel` |
| `MorphTo` | `RelatedModel` |
| `HasOneThrough` | `RelatedModel` |
| `HasMany` | `RelatedModel[]` |
| `BelongsToMany` | `RelatedModel[]` |
| `MorphMany` | `RelatedModel[]` |
| `MorphToMany` | `RelatedModel[]` |
| `HasManyThrough` | `RelatedModel[]` |

## Configuration Options

### `enabled`

Enable or disable the endpoint. **Always disable in production!**

```php
'enabled' => env('TYPESCRIPT_MODELS_ENABLED', false),
```

### `route`

The URL path for the endpoint.

```php
'route' => env('TYPESCRIPT_MODELS_ROUTE', '/api/typescript-models'),
```

### `middleware`

Middleware to apply to the route.

```php
'middleware' => ['api'],
```

### `allowed_ips`

Whitelist of allowed IP addresses. Empty array allows all IPs.

```php
'allowed_ips' => ['127.0.0.1', '::1'],
```

### `require_token` & `token`

Token-based authentication settings.

```php
'require_token' => env('TYPESCRIPT_MODELS_REQUIRE_TOKEN', true),
'token' => env('TYPESCRIPT_MODELS_TOKEN'),
```

### `models_paths`

Directories to scan for Eloquent models.

```php
'models_paths' => [
    app_path('Models'),
    // app_path('Domain/User/Models'),
],
```

### `exclude_models`

Models to exclude from generation.

```php
'exclude_models' => [
    App\Models\PersonalAccessToken::class,
],
```

### `properties_mode`

How to determine model properties:

- `fillable` - Only `$fillable` properties (default, safest)
- `database` - Read columns from database schema
- `both` - Combine both approaches

```php
'properties_mode' => env('TYPESCRIPT_MODELS_PROPERTIES_MODE', 'fillable'),
```

### `include_accessors`

Include accessor methods (getXxxAttribute) in the output.

```php
'include_accessors' => env('TYPESCRIPT_MODELS_INCLUDE_ACCESSORS', false),
```

### `include_relations`

Include relationship methods in the output.

```php
'include_relations' => env('TYPESCRIPT_MODELS_INCLUDE_RELATIONS', true),
```

## Security Recommendations

1. **Never enable in production** - Set `TYPESCRIPT_MODELS_ENABLED=false` in production
2. **Use strong tokens** - Generate a secure random token
3. **Restrict IPs** - Limit to localhost or known development IPs
4. **Use HTTPS** - Always use HTTPS when transmitting tokens
5. **Exclude sensitive models** - Don't expose internal/admin models

## Type Mapping

| PHP/Laravel Type | TypeScript Type |
|------------------|-----------------|
| `int`, `integer` | `number` |
| `float`, `double`, `decimal` | `number` |
| `bool`, `boolean` | `boolean` |
| `array`, `json`, `collection` | `any[]` |
| `object` | `Record<string, any>` |
| `datetime`, `date`, `timestamp` | `Date` |
| `string` (default) | `string` |

## Testing Locally

To test this package in a local Laravel project before publishing:

1. Add to your Laravel project's `composer.json`:

```json
{
    "repositories": [
        {
            "type": "path",
            "url": "../laravel-typescript-models"
        }
    ]
}
```

2. Install the package:

```bash
composer require campelo/laravel-typescript-models:dev-main
```

3. Publish config and configure your `.env`

4. Test the endpoint

## License

MIT License - see [LICENSE](LICENSE) file.
